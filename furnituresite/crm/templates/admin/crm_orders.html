{% extends "admin/base_site.html" %}

{% block extrahead %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è CRM</h1>

    <p>
        <a href="{% url 'crm_admin:crm-analytics' %}" class="btn btn-success">
            üìä –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏
        </a>
    </p>

    <form id="filterForm" class="row g-3 mb-4">
        <div class="col-md-2">
            <select name="status" class="form-select">
                <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
                <option value="pending">‚è≥ –í –æ–±—Ä–æ–±—Ü—ñ</option>
                <option value="completed">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
            </select>
        </div>
        <div class="col-md-3">
            <input type="text" name="customer" class="form-control" placeholder="–ö–ª—ñ—î–Ω—Ç">
        </div>
        <div class="col-md-2">
            <input type="date" name="date_from" class="form-control">
        </div>
        <div class="col-md-2">
            <input type="date" name="date_to" class="form-control">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">üîç –ü–æ—à—É–∫</button>
        </div>
    </form>

    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>–ö–ª—ñ—î–Ω—Ç</th>
                <th>–î–∞—Ç–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody id="ordersTable">
            {% for order in orders %}
            <tr>
                <td>{{ order.id }}</td>
                <td>{{ order.customer }}</td>
                <td>{{ order.date_ordered|date:"Y-m-d H:i" }}</td>
                <td>
                    {% if order.complete %}
                        <span class="badge bg-success">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">‚è≥ –í –æ–±—Ä–æ–±—Ü—ñ</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.getElementById("filterForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const form = e.target;
    const params = new URLSearchParams(new FormData(form));

    fetch("?" + params.toString(), {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(res => res.json())
    .then(data => {
        const tbody = document.getElementById("ordersTable");
        tbody.innerHTML = "";

        if (data.orders.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center">–ù–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å</td></tr>`;
        } else {
            data.orders.forEach(order => {
                tbody.innerHTML += `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.customer}</td>
                        <td>${order.date}</td>
                        <td>${order.status}</td>
                    </tr>
                `;
            });
        }
    });
});
</script>
{% endblock %}
