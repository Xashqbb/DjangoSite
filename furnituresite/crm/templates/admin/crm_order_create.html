{% extends "admin/base_site.html" %}

{% block extrahead %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    /* –ü–æ–ª–µ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ ‚Äì –∑–∞–≤–∂–¥–∏ –±—ñ–ª–∏–π —Ñ–æ–Ω */
    input[type="number"] {
        background-color: #fff !important;
        color: #000 !important;
    }

    /* –ü–æ–ª–µ –∫–ª—ñ—î–Ω—Ç–∞ ‚Äì –Ω–µ –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω */
    #customer {
        max-width: 500px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        height: auto;
    }

    /* Select –¥–ª—è —Ç–æ–≤–∞—Ä—ñ–≤ */
    .product-select {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        height: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">‚ûï –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

    <p>
        <a href="{% url 'crm_admin:crm-orders' %}" class="btn btn-secondary">
            ‚Üê –ù–∞–∑–∞–¥ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω—å
        </a>
    </p>

    <form id="createOrderForm" class="mb-4">
        <!-- –í–∏–±—ñ—Ä –∫–ª—ñ—î–Ω—Ç–∞ -->
        <div class="mb-3">
            <label for="customer" class="form-label">–ö–ª—ñ—î–Ω—Ç</label>
            <select class="form-select" id="customer" name="customer" required>
                <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞ --</option>
                {% for c in customers %}
                <option value="{{ c.id }}" title="{{ c.name }} {{ c.surname }} ({{ c.email }})">
                    {{ c.name }} {{ c.surname }} ({{ c.email }})
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤ -->
        <div class="mb-3">
            <label class="form-label">–¢–æ–≤–∞—Ä–∏</label>
            <div id="itemsContainer"></div>
            <button type="button" id="addItemBtn" class="btn btn-outline-primary btn-sm mt-2">
                ‚ûï –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä
            </button>
        </div>

        <button type="submit" class="btn btn-success">‚úÖ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
    </form>
</div>

<script>
// –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ä—è–¥–∫–∞ –¥–ª—è —Ç–æ–≤–∞—Ä—É
document.getElementById("addItemBtn").addEventListener("click", function() {
    const container = document.getElementById("itemsContainer");

    const div = document.createElement("div");
    div.className = "row g-2 mb-2 align-items-center";
    div.innerHTML = `
        <div class="col-md-6">
            <select class="form-select product-select" name="product">
                <option value="">-- –û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä --</option>
                {% for p in products %}
                <option value="{{ p.id }}" title="{{ p.name }} ({{ p.price }} –≥—Ä–Ω)">
                    {{ p.name }} ({{ p.price }} –≥—Ä–Ω)
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <input type="number" name="quantity" class="form-control" min="1" value="1">
        </div>
        <div class="col-md-3">
            <button type="button" class="btn btn-danger btn-sm removeItem">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
    `;
    container.appendChild(div);

    div.querySelector(".removeItem").addEventListener("click", function() {
        div.remove();
    });
});

// –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º–∏ AJAX
document.getElementById("createOrderForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const customer = document.getElementById("customer").value;
    const items = [];
    document.querySelectorAll("#itemsContainer .row").forEach(row => {
        const product = row.querySelector("select[name='product']").value;
        const quantity = row.querySelector("input[name='quantity']").value;
        if (product) {
            items.push({ product, quantity });
        }
    });

    fetch("{% url 'crm_admin:crm-create-order-ajax' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ customer, items })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ!");
            window.location.href = "{% url 'crm_admin:crm-orders' %}";
        } else {
            alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + data.error);
        }
    });
});
</script>
{% endblock %}
